<!-- Toolbar -->
<mat-toolbar color="primary" class="mat-elevation-z4 sticky-header">
    <mat-icon class="mr-2">description</mat-icon>
    <span>MercadoPago Scraper (Angular)</span>
    <span class="spacer"></span>

    @if(file){
    <div class="toolbar-actions">
        <span class="filename">{{file.name}}</span>

        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="row-input dense-form-field">
            <mat-label>Inicio (LÃ­nea)</mat-label>
            <input matInput type="number" [(ngModel)]="startRow" [disabled]="isProcessing" min="2">
        </mat-form-field>

        <button mat-stroked-button color="accent" (click)="openFileDialog()" [disabled]="isProcessing"
            class="contrast-btn">
            <mat-icon>folder_open</mat-icon> Cambiar Excel
        </button>

        <button mat-raised-button color="accent" (click)="download()" [disabled]="isProcessing || data.length === 0">
            <mat-icon>download</mat-icon> Exportar
        </button>

        <mat-slide-toggle [(ngModel)]="showBrowser" [disabled]="isProcessing" color="warn" class="mr-2">
            Ver proceso
        </mat-slide-toggle>

        <button mat-raised-button class="run-btn" (click)="startScraping()" [disabled]="isProcessing">
            @if(!isProcessing){
            <mat-icon>play_arrow</mat-icon>
            } @else {
            <mat-icon>sync</mat-icon>
            }
            {{ isProcessing ? 'Procesando...' : 'Iniciar' }}
        </button>
    </div>
    }
</mat-toolbar>

<div class="container-fluid">
    <!-- File Input (always available, hidden) -->
    <input #fileInput type="file" (change)="onFileSelected($event)" accept=".xlsx, .xls" style="display:none">

    <!-- Upload State -->
    @if(!file){
    <div class="upload-container">
        <mat-card class="upload-card">
            <mat-card-content class="upload-content">
                <mat-icon class="upload-icon">cloud_upload</mat-icon>
                <h2>Cargar Archivo Excel</h2>
                <p>Selecciona el archivo .xlsx para comenzar el proceso</p>
                <button mat-raised-button color="primary" (click)="openFileDialog()">
                    Seleccionar Archivo
                </button>
            </mat-card-content>
        </mat-card>
    </div>
    }

    <!-- Main Workspace -->
    @if(file){
    <div class="workspace-grid">

        <!-- Left: Table -->
        <div class="table-container mat-elevation-z2">
            <table mat-table [dataSource]="data" class="full-width-table">

                <!-- Row Num Column -->
                <ng-container matColumnDef="__rowNum__">
                    <th mat-header-cell *matHeaderCellDef> # </th>
                    <td mat-cell *matCellDef="let row"> {{row.__rowNum__}} </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef> Estado </th>
                    <td mat-cell *matCellDef="let row">
                        <mat-chip-set>
                            <mat-chip [class]="'chip-' + row.status.toLowerCase()" highlighted>
                                {{row.status}}
                            </mat-chip>
                        </mat-chip-set>
                    </td>
                </ng-container>

                <!-- Dynamic Columns -->
                @for (col of headers.slice(0, 4); track col) {
                <ng-container [matColumnDef]="col">
                    <th mat-header-cell *matHeaderCellDef> {{col}} </th>
                    <td mat-cell *matCellDef="let row"> {{row[col]}} </td>
                </ng-container>
                }

                <!-- Message Column -->
                <ng-container matColumnDef="message">
                    <th mat-header-cell *matHeaderCellDef> Info Scraping </th>
                    <td mat-cell *matCellDef="let row" class="italic-text"> {{row.message}} </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" [ngClass]="getRowClass(row)"></tr>
            </table>
        </div>

        <!-- Right: Sticky Console -->
        <div class="console-wrapper">
            <mat-card class="console-card">
                <mat-card-header class="console-header">
                    <mat-card-title class="console-title">
                        <mat-icon class="console-icon">terminal</mat-icon> Consola de Sistema
                    </mat-card-title>
                </mat-card-header>

                <mat-card-content>
                    <div class="log-output" #logContainer>
                        @for (log of logs; track log) {
                        <div class="log-line">
                            <span class="log-time">[{{ log.timestamp | date:'mediumTime' }}]</span> {{log.message}}
                        </div>
                        }
                        @if(logs.length === 0){
                        <div class="log-empty">Sistema listo. Esperando inicio...</div>
                        }
                        <button mat-icon-button (click)="clearLogs()" title="Limpiar logs"
                            style="position: fixed; top: 90px; right: 20px; z-index: 10;">
                            <mat-icon>delete_sweep</mat-icon>
                        </button>
                    </div>
                </mat-card-content>

                @if(isProcessing){
                <mat-card-footer>
                    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                </mat-card-footer>
                }
            </mat-card>
        </div>

    </div>
    }
</div>